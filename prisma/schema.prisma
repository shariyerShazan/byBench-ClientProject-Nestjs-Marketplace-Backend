// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
   output        = "./generated/prisma"
   moduleFormat    = "cjs"
    binaryTargets   = ["native"]
}


datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}







model Auth {
  id        String   @id @default(uuid()) 
  firstName String
  lastName  String
  nickName String
  email     String   @unique
  phone     String   @unique
  password  String
  otp       String?  
  otpExpires  DateTime?
  profilePicture String?
  otpAttemp Int      @default(0)
  lastLogin DateTime @default(now())
  isVerified Boolean  @default(false) 
  isSuspended  Boolean @default(false)
  role      Role     @default(USER)

  isSeller       Boolean @default(false)
  sellerProfile SellerProfile?

  comments       Comment[]

  bids           Bid[]   
  postedAds       Ad[]           @relation("SellerAds")
  boughtAds       Ad[]           @relation("BuyerAds")
  
  payments        Payment[]      @relation("BuyerPayments") 

  sentMessages    Message[]      @relation("SentMessages")
  conversations   Participant[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SellerProfile {
  id             String  @id @default(uuid())
  companyName    String
  companyWebSite String  @unique
  address  String
  city    String
  state   String
  zip     Int
  country String

  status         SellerStatus @default(PENDING)
  adminNote      String?

   stripeAccountId      String? @unique 
   isStripeVerified    Boolean  @default(false)

  isDeleted Boolean @default(false)

  auth           Auth    @relation(fields: [authId], references: [id], onDelete: Cascade)
  authId         String  @unique
}






















// Complete Industry Standard Schema for Marketplace & Auction

model Category {
  id            String        @id @default(uuid())
  name          String        @unique 
  slug          String        @unique
  image         String?
  subCategories SubCategory[]
  ads           Ad[]
}

model SubCategory {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  category    Category @relation(fields: [categoryId], references: [id])
  categoryId  String
  ads         Ad[]
}

model Ad {
  id            String      @id @default(uuid())
  title         String
  description   String      @db.Text
  type          AdType      @default(FIXED)
  price         Float?
  basePrice     Float?
  releasePrice  Float?
  propertyFor   PropertyFor @default(SALE)
  rentalPeriod  String?
  startTime     DateTime?
  endTime       DateTime?

  latitude    Float?        
  longitude   Float?  

  specifications Json?

  country       String      @default("USA")
  state         String
  city          String
  zipCode       String?

  showAddress   Boolean     @default(true)
  allowPhone    Boolean     @default(true)
  allowEmail    Boolean     @default(true)

  isSold    Boolean @default(false)

  buyerId         String? 
  buyer           Auth?          @relation("BuyerAds", fields: [buyerId], references: [id])
  seller          Auth           @relation("SellerAds", fields: [sellerId], references: [id])
  sellerId        String


  viewerIds     String[]    @default([])

  images        AdImage[]
  category      Category    @relation(fields: [categoryId], references: [id])
  categoryId    String
  subCategory   SubCategory @relation(fields: [subCategoryId], references: [id])
  subCategoryId String

  bids          Bid[]
  comments       Comment[]
  payment       Payment?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}


model Comment {
  id        String   @id @default(uuid())
  message   String
  parentId  String? // for replies
  createdAt DateTime @default(now())

  userId    String
  user    Auth      @relation(fields: [userId], references: [id])

  adId      String
  ad      Ad        @relation(fields: [adId], references: [id])
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id])

  replies Comment[] @relation("CommentReplies")
}


model AdImage {
  id        String  @id @default(uuid())
  url       String
  isPrimary Boolean @default(false) 
  ad        Ad      @relation(fields: [adId], references: [id], onDelete: Cascade)
  adId      String
}

model Bid {
  id        String   @id @default(uuid())
  amount    Float
  bidder    Auth     @relation(fields: [bidderId], references: [id])
  bidderId  String
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  adId      String
  createdAt DateTime @default(now())
}



model Payment {
  id           String        @id @default(uuid())
  stripeId     String        @unique
  totalAmount  Float   
  adminFee     Float     
  sellerAmount Float     

  adId         String        @unique
  ad           Ad            @relation(fields: [adId], references: [id])

  buyerId         String
  buyer           Auth           @relation("BuyerPayments", fields: [buyerId], references: [id])

  status       PaymentStatus @default(PENDING)
  createdAt    DateTime      @default(now())
}




enum Status {
  PENDING
  COMPLETED
  FAILED
}





enum Role {
  USER 
  ADMIN 
  SELLER 
}

enum SellerStatus {
  PENDING
  APPROVED
  REJECTED
}

// Enums
enum AdType {
  FIXED
  AUCTION
}

enum PropertyFor {
  SALE
  RENT
}


// enum AdStatus {
//   PENDING
//   APPROVED
//   SOLD
//   EXPIRED
//   REJECTED
// }

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}























// chat section .. 
model Conversation {
  id           String        @id @default(uuid())
  isBlocked    Boolean       @default(false)
  blockedById  String?      
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  messages     Message[]
  participants Participant[]
}

model Participant {
  id             String       @id @default(uuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
  user           Auth         @relation(fields: [userId], references: [id])
  userId         String

  @@unique([conversationId, userId])
}

model Message {
  id             String       @id @default(uuid())
  text           String?      @db.Text
  fileUrl        String?      
  fileType       String?      
  
  sender         Auth         @relation("SentMessages", fields: [senderId], references: [id])
  senderId       String
  
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
  
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
}

